# Solar Installation Cost Computation

## Introduction

This demo illustrates computing a solar installation cost estimate, the rebate the user could get, how much savings they would get yearly 
and get some loan offers to finance the installation.
 
It is a Web and Cloud Serverless application that integrates Corticon.js with AWS Step Functions. 
The aim of this sample is to show composite applications.  By composite applications, we mean applications that mesh 
together various services to compose a main application. 
Additionally, we aim to demonstrate composing the application using several discrete (more atomistic) decision services that do 
a specific job well; as opposed to having a single, much larger decision service that gathers data and compute all the results.

To demonstrate these concepts, our demo app links together several Corticon.js Decision Services and Rest Services in an AWS Step 
functions workflow using a non-trivial use case.

Limitations: The application is programmed for a couple of US states, namely CA, MA and NY.

## How does the application work?

The application has the following architecture:
- The UI is a Web Browser application
- An AWS API Gateway entry point to kick start the workflow.
- An AWS Step functions state machine to execute various Corticon.js decision services and REST services inside AWS Lambda, mesh and compute data (rebate, savings, loans...) and return the results.  This workflow runs in the background asynchronously.  
The client will poll to find when the execution has completed and display the results. 

### A bit about each component

- A bit about the client: it is a typical HTML/JS(JQuery) application.  It contains a form where users enter some data about their residence.  
It then triggers the workflow (AWS step functions) via an HTTP call to an AWS/API Gateway entry point. In the left side-panel, the application shows the progress of the state machine
 and various computed metrics after the step function has completed. The progress is shown for illustrative purposes when one does not have access to the AWS console to see the 
 state machine executing.  In reality, the state machine executes pretty fast as the REST services are simulated in Lambda functions and have no wait time.
- A bit about the decision services: they do complex logic analysis and computations based on state of residence and various other input parameters.  See section below for details on what each rule sheet does
- a bit about REST services: they provide additional data required for computing the cost, rebate and savings.  Even though they are implemented as
simple JavaScript Lambda functions to keep the demo manageable, they illustrate very well composite applications and in particular how to integrate data 
coming from different sources.   
- A bit about the cloud side state machine: the demo includes an example of each key feature of Step functions, 
    - we have sequential steps, to show how to decompose the application into discrete decision services
    - we have a parallel step to show 2 independent execution happening at the same time.  It is interesting to see how to data is passed in and out of that step.
    - we have a conditional step to compute loan offers if user selected that option.

This project is broken up into two directories.
- The "Client UI" directory contains the HTML client.  You can simply use that to see it in action (no need to create a separate state machine)
- The "Step Functions Assets" contains the definition of the state machine (the step functions), the associated Lambda functions 
as well as the Corticon.js decision services rules set and rule flows.  Use these if you want to create the step functions and associated Lambda functions in a separate AWS environment.

Note: some of the index.js Lambda functions generated by Corticon.js are customized to manipulate the payload coming from the
previous step.  The modified index.js are available in "Customized DS Lambda Entry Points".
If you update the decision service and redeploy to AWS Lambda using the zip file the index.js will be overwritten,
please be sure to only upload the decision service bundle file (decisionServiceBundle.js).

### Decision Services Documentation
This section describes what each Rulesheet role and the kind of computation it does.

#### Constants.ers

The same decision service is used in both "Solar Constants" step and in "Solar Price Constants" step.

In first call it will set some default values:
- Constants.DefaultInstallationSize 
- Constants.DefaultRequiredRoofSpace 

In second call, it requires input data from the REST service.  Namely, it needs, 
- Constants.PanelPricePerWatt
- Constants.Cost_kWhr

And it will compute:
- Property.EstimatedInstallationCost
- Property.MonthlyElectricConsumption

From then on, these are used in various decision services.


#### Rebate_US.ers  (Solar Rebate)

The rule flow only executes the rebate for the USA (Rebate_US.ers).  This rule sheet computes a flat rebate and an additional rebate 
based on residence **State** and **Type** of residence.

#### Quote.ers (Solar Quote)

Very simple rule sheet - see rule sheet for the single formula. It outputs a new quote based on various rebates and estimated cost.

#### Savings.ers (Solar Savings)
Calculates the estimated savings each month by determining how much electricity we anticipate the user's system generates based on **Shade** and **Orientation** and empirical data. This savings can be a maximum of up to the **Monthly Electric Bill**


#### Loan.ers (Solar Loan)

Determines which loan options the user qualifies for based on **Property Value**, **Property Age**, and **Property Type**. Specifically in conjunction with the provided Solar Loan Rest, this Decision Service will select two out of the twelve loan options.

The Loans come in two types (0% and 50% down), each with 2 yr and 5 yr timeframes. Additionally there are 3 tiers with increasing interest rates that we select based on the **Property Age**


### Mapping of State Machine Names, Decision Services Names and Lambda Function Names

This table shows the mapping of state machine names, the applicable Rule flows names and the Lambda functions (and rest files when applicable).

| State Machine Name | Rule Flow Name | Associated Lambda Function Name|
| ----------- | ----------- | ------ |
| DS_Solar_Constants | Constants.erf | solar_price_constants |
| DS_Solar_PriceConstants | Constants.erf | solar_price_constants |
| Rest_Solar_Price | n/a | REST Services/solar_price_rest.js |
| DS_Solar_Rebate | Rebate.erf | solar_rebate |
| DS_Solar_Savings | Savings.erf | solar_savings |
| DS_Solar_PriceQuote | Quote.erf | solar_quote |
| DS_Solar_Rebate | Rebate.erf | solar_rebate |
| Rest_Solar_Loan | n/a | REST Services/solar_loan_rest.js |
| DS_Solar_Loan | ???? | solar_loan |
| SuccessState | n/a | n/a This is just a Succeed state as we cannot go to end directly from the branch |

### REST Services

There are 2 REST services:
- solar_price_rest.js: provides electricity cost in the state and solar panel cost.  See file for more details.
- solar_loan_rest.js: provides 4 different loan types with 3 tiers for each type. See file for more details.

## Demo Points
### Inputs to the Step Function
Every field except **Street Address**, **City**, and **Roof Size** affect the output in some way. See the section below on Outputs to what each input affects

### Step Function
The data in the first two steps of the form are sent via HTTP Post to and APIGateway that is configured to execute step functions. The Post request contains the **ARN** (Amazon Resource Number) of the **AWS Step Function** we configured and this triggers a new execution of the Step Function.

The structure of the Step Function's **State Machine** can be seen on the **Getting Your Rebate** form step. As soon as you enter this step, the diagram will be updated as each step completes. Note: This is not actually tied with the Step Function's execution as the real step function executes too quickly. To simulate a reasonably large workflow there is a configurable delay located at the top of `Client UI/corticon.js`

### Outputs from the Step Function / Decision Services
There are four main outputs in this demo: the Rebate, Quote, Savings and Loan Options.

Rebate: How much you save upfront, or immediately via tax rebates
	- The main factors are the **State** and **Type**
	- "Residential" type properties qualify for better rebates
	- "Commercial" and "Other" type properties only qualify for the base Federal rebate

Quote: The net cost after factoring in rebate
	- Currently only changeable indirectly by modifying the Rebate

Savings: How much you save on monthly electric bill, and cumulatively over a 20 year period
	- The savings is capped by your **Monthly Electric Bill** (you can't save more electricity than you consume)
	- Lower your **Monthly Electric Bill** to see the savings drop
	- The **Orientation** and **Shade** affect how much electricity we predict your system will generate
	- Southerly facing **Orientations** and less **Shade** increases generation and vice versa

Loan Options: The two Financing Options provided
	- Each pair of loan options has a 2 year and 5 year option
	- If your Property **Value** is <=500000, we recommend a 0% down option
	- If your Property **Value** is >500000, we recommend a 50% down option
	- In addition, the  **Age** affects the loan tier / the interest rate on the loan marginally (<5, 5..10, >10)
	- "Commercial" **Type** Properties are locked into Tier 2 50% down options only


## Setup

Introduction of what options you have

## Client Setup
Once you have all the files, open up index.html (preferably in Chrome) in the 'Client UI' directory

## AWS Setup
This section is for recreating the AWS step function and related components on your own AWS account.


There are four different AWS Services you will need to recreate:
- Roles for StepFunction and APIGateway
- Step Function
- Lambda Functions
- API Gateway to Step Function

### StepFunctionsLambdaRole + APIGatewayToStepFunctionsRole
If there is no existing StepFunctionsLambdaRole or if you want your own copy that is not shared by another resource
- Go to `console.aws.amazon.com/iam` > **Roles** > **Create Role**
- Select **Step Functions** > **Next: Permissions**
- You should see AWSLambdaRole by default in the list. If not add it manually
- Click **Next: Tags** > **Next: Review** to move to the last step
- Add whatever Role Name you would like and corresponding description.

If there is no existing APIGatewayToStepFunctionsRole or if you want your own copy that is not shared by another resource
- Go to `console.aws.amazon.com/iam` > **Roles** > **Create Role**
- Select **API Gateway** > **Next: Permissions**
- Click **Next: Tags** > **Next: Review** to move to the last step
- Add whatever Role Name you would like and corresponding description.
- Find your newly created role on the **Roles** page
- Go to the **Permission** tab and select **Attach Policy**
- Search for `AWSStepFunctionsFullAccess` and click **Attach Policy** 

### Creating your Step Function
If you haven't already, go ahead and create your Step Function.
- Navigate to **Step Functions** from the **Service** dropdown.
- Click **Create state machine**
	- The default selected setup options are fine for the purposes of this demo. 
- Click **Next** to move to the **Specify Detail** screen
	- Enter your **State machine name**
	- Under **Permissions**, select **Choose an existing role** and choose StepFunctionsLambdaRole or the role you created earlier
- Go ahead and finish up and click **Create State Machine**

### Defining your Step Function
Now that you have your Step Function you have to define the states using a special JSON-based syntax. If you want more detail or are stuck on something, please refer to `https://docs.aws.amazon.com/step-functions/latest/dg/concepts-states.html`

For now, just paste the contents of [statemachine_definition.json](./Step%20Functions%20Assets/statemachine_definition.json) into the definition text editor.

### Creating the Decision Service Lambdas / REST Services
- First create a new AWS lambda function from **Services** > **Lambda** > **Create Function** 
- Give your new function a name (eg. 'Solar_Constants_Lambda')
- Click **Create Function**
- Under the Function Code section, open the **Actions** dropdown in the upper right and select **Upload a .zip file**
- Upload the zip file for the corresponding Lambda Function / REST Service under `Decision Services/Customized DS Lambda Entry Points` and `RestServices`

Once you have setup your Decision Service and REST Lambdas, find the **arn** located in the upper right on their respective page. Then replace the arn inside your Step Function definition with your new arn!

### APIGateway to StepFunction
Please follow the [provided documentation](https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-api-gateway.html)

## Testing Your Setup

Use the postman assets.  More details at CompositeApps/AWS Step Functions/Solar Installation/Unit Tests/readme.md

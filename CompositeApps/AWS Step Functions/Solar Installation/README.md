# Solar Rebate
This is a Web Application that integrates Corticon.js with AWS Step Functions. The aim of this sample is to demonstrate different ways to link together seperate Decision Services and Rest Services in a non-trivial use case.

This project is broken up into two directories.
- The "Client UI" directory contains the HTML client.
- The "Step Functions Assets" contains the definition of the state machine (the step functions), the associated Lambda functions 
as well as the Corticon.js decision services rules set and rule flows.

Note: some of the index.js Lambda functions generated by Corticon.js are customized to manipulate the payload coming from the
previous step.  The modified index.js are available in "Customized DS Lambda Entry Points".
If you update the decision service and redeploy to AWS Lambda using the zip file the index.js will be overwritten,
please be sure to only upload the decision service bundle file (decisionServiceBundle.js).


TODO: demo points



## Setup
Once you have all the files, open up index.html (preferrably in Chrome) in the 'Client UI' directory

## AWS Setup
This section is for recreating the AWS step function and related components on your own AWS account.


There are four different AWS Services you will need to recreate:
- Roles for StepFunction and APIGateway
- Step Function
- Lambda Functions
- API Gateway to Step Function

### StepFunctionsLambdaRole + APIGatewayToStepFunctionsRole
If there is no existing StepFunctionsLambdaRole or if you want your own copy that is not shared by another resource
- Go to `console.aws.amazon.com/iam` > **Roles** > **Create Role**
- Select **Step Functions** > **Next: Permissions**
- You should see AWSLambdaRole by default in the list. If not add it manually
- Click **Next: Tags** > **Next: Review** to move to the last step
- Add whatever Role Name you would like and corresponding description.

If there is no existing APIGatewayToStepFunctionsRole or if you want your own copy that is not shared by another resource
- Go to `console.aws.amazon.com/iam` > **Roles** > **Create Role**
- Select **API Gateway** > **Next: Permissions**
- Click **Next: Tags** > **Next: Review** to move to the last step
- Add whatever Role Name you would like and corresponding description.
- Find your newly created role on the **Roles** page
- Go to the **Permission** tab and select **Attach Policy**
- Search for `AWSStepFunctionsFullAccess` and click **Attach Policy** 

### Creating your Step Function
If you haven't already, go ahead and create your Step Function.
- Navigate to **Step Functions** from the **Service** dropdown.
- Click **Create state machine**
	- The default selected setup options are fine for the purposes of this demo. 
- Click **Next** to move to the **Specify Detail** screen
	- Enter your **State machine name**
	- Under **Permissions**, select **Choose an existing role** and choose StepFunctionsLambdaRole or the role you created earlier
- Go ahead and finish up and click **Create State Machine**

### Defining your Step Function
Now that you have your Step Function you have to define the states using a special JSON-based syntax. If you want more detail or are stuck on something, please refer to `https://docs.aws.amazon.com/step-functions/latest/dg/concepts-states.html`

For now, just paste the contents of [statemachine_definition.json](./Step%20Functions%20Assets/statemachine_definition.json) into the definition text editor.

### Creating the Decision Service Lambdas / REST Services
You've seen how to create a task state, but you don't have the lambdas you want to invoke yet.

- First create a new AWS lambda function from **Services** > **Lambda** > **Create Function** 
- Give your new function a name (eg. 'Solar_Constants_Lambda')
- Click **Create Function**
- Under the Function Code section, open the **Actions** dropdown in the upper right and select **Upload a .zip file**
- Upload the zip file for the corresponding Lambda Function / REST Service under `Decision Services/Customized DS Lambda Entry Points` and `RestServices`

Once you have setup your Decision Service and REST Lambdas, find the **arn** located in the upper right on their respective page. Then replace the arn inside your Step Function definition with your new arn!

### APIGateway to StepFunction
Please follow the provided documentation at `https://docs.aws.amazon.com/step-functions/latest/dg/tutorial-api-gateway.html`

## Demoing
